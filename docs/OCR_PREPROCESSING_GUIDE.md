# OCR 试卷预处理指南

> 在使用 `ocr_to_examx.py` 转换前，需要对 OCR 生成的 Markdown 文件进行预处理

## 脚本功能概览

`tools/utils/preprocess_ocr_markdown.py` 支持以下自动处理：

| 功能 | 说明 |
|------|------|
| ✅ 删除分页标记 | `<br><span class='markdown-page-line'>...</span>` |
| ✅ 删除点评内容 | `点评：xxx` 到下一题为止 |
| ✅ 修复 LaTeX 空格 | `\thereforeA` → `\therefore A` |
| ✅ 修复 OCR 符号 | `∳` → `∴` |
| ✅ 拆分同行选项 | `A. xxx B. yyy` → 分行 |
| ✅ 替换 textcircled | `\textcircled{1}` → `①` |
| ✅ 修复标题前缀 | `# 一、选择题` → `## 一、选择题` |
| ✅ 压缩空行 | 最多保留 2 行空行 |
| ⚠️ 检测题目顺序 | 报告错乱/缺失，需手动修复 |

---

## 常见问题及解决方案

### 1️⃣ 分页标记打断题目（最常见）

**问题表现：**
```markdown
4. 若数列$\{a_{n}\}$满足...则称$\{a_{n}\}$为"等方比数列". 甲:  

3. 已知直线$l,m,n$...  ← 这是第3题，但OCR把它放在第4题开头后面了

【答案】D
【解析】...

<br><span class='markdown-page-line'>---[ 第2页 ]---</span><br><br>

数列$\{a_{n}\}$是等方比数列；乙：数列$\{a_{n}\}$是等比数列，则  ← 这是第4题的续
```

**修复方法：**
1. 删除分页标记 `<br><span class='markdown-page-line'>...</span><br><br>`
2. 将第4题的两个部分合并：
```markdown
4. 若数列$\{a_{n}\}$满足...则称$\{a_{n}\}$为"等方比数列". 
   甲: 数列$\{a_{n}\}$是等方比数列；
   乙：数列$\{a_{n}\}$是等比数列，则

A. 甲是乙的充分不必要条件
...

【答案】B
【解析】...
```

### 2️⃣ 题目顺序错乱（需手动修复）

**问题表现：**
- 题目不是按 1, 2, 3, 4... 顺序排列
- 第4题可能出现在第3题前面

**脚本会自动检测并报告：**
```
⚠️ 题号不连续：第2题后跳到第4题，缺少 [3]
⚠️ 题目顺序错乱：第3题（行34）出现在第4题之后
```

**修复方法：**
- 手动移动整个题目块（包括题目、选项、答案、解析）到正确位置

### 3️⃣ Markdown 标题前缀 ✅ 自动处理

**问题表现：**
```markdown
# 一、选择题...
# 【解析】
# 深度挖掘与改编
```

### 4️⃣ 点评内容 ✅ 自动删除

**问题表现：**
```markdown
【解析】...选B.

点评：（关于三次函数极值点与方程实根个数）
这题的题面看起来比较坏...（一大段点评文字）

8. 下列对于函数...  ← 下一题
```

### 5️⃣ LaTeX 命令后缺空格 ✅ 自动修复

支持的命令：`\therefore`, `\because`, `\Rightarrow`, `\forall`, `\exists` 等

### 6️⃣ 选项在同一行 ✅ 自动拆分

**问题表现：**
```markdown
A. $f(x+2)=f(x)$B. $f(\log_{2}3)=\frac{2}{3}$
```

### 7️⃣ OCR 错误符号 ✅ 自动修复

- `∳` → `∴` (therefore)
- `．` → `.` (全角转半角)

---

## 推荐预处理流程

### 步骤 1：运行预处理脚本（检查模式）

```bash
python3 tools/utils/preprocess_ocr_markdown.py input.md --check-only -v
```

查看报告的问题，特别是**题目顺序错乱**（需要手动修复）。

### 步骤 2：手动修复题目顺序（如有）

在 VS Code 中打开原始 Markdown 文件：

1. **搜索题号**：`^[0-9]+[.．]` (正则)
2. **确保顺序正确**：1, 2, 3, 4...
3. **移动整个题目块**（包括选项、答案、解析）

### 步骤 3：运行预处理脚本（完整处理）

```bash
python3 tools/utils/preprocess_ocr_markdown.py input.md -o output.md -v
```

**可选参数：**
- `-o FILE`：输出文件（不指定则输出到 stdout）
- `-v`：显示详细信息
- `--no-sections`：不自动插入分节标题
- `--section "1:一、选择题"`：自定义分节

### 步骤 4：运行转换脚本

```bash
python3 tools/core/ocr_to_examx.py preprocessed.md output_dir/
```

---

## 快速检查清单

| 问题 | 搜索正则 | 自动处理 |
|------|----------|----------|
| 分页标记 | `markdown-page-line` | ✅ |
| 题号错乱 | 手动检查 1,2,3... 顺序 | ⚠️ 仅检测 |
| 点评内容 | `^点评[：:]` | ✅ |
| 标题前缀 | `^#\s` | ✅ |
| LaTeX空格 | `\\therefore[a-zA-Z]` | ✅ |
| OCR符号 | `∳` | ✅ |

---

## 此文件适用的试卷

经过预处理后，以下格式的试卷可以正常转换：

✅ 图片直接 OCR 的试卷（如深圳中学格式）  
✅ PDF OCR 导出的 Markdown  
✅ 包含 【答案】【解析】 标记的试卷  
✅ 选择题、填空题、解答题混合  
✅ 包含图片引用 `![](images/xxx.jpg)`  
✅ 使用 $...$ 或 $$...$$ 的数学公式

❌ 需要手动额外处理的情况：
- 题目顺序错乱（脚本会检测并报告）
- 没有明确的【答案】【解析】标记
- 解析与下一题混在一起
✅ 包含图片引用 `![](images/xxx.jpg)`
✅ 使用 $...$ 或 $$...$$ 的数学公式

❌ 需要额外处理的情况：
- 题目被分页切成多段
- 没有明确的【答案】【解析】标记
- 解析与下一题混在一起
