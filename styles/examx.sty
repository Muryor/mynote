
% styles/examx.sty
\NeedsTeXFormat{LaTeX2e}
\ProvidesExplPackage{examx}{2025-10-28}{1.3.0}
  {Unified metadata & teacher/student rendering for exam-zh}

% --- Dependencies
\RequirePackage{expl3}[2022-06-01]
\RequirePackage{xparse}
\RequirePackage{etoolbox}
\RequirePackage{l3keys2e}
\RequirePackage{xcolor}
\RequirePackage{tcolorbox}
\tcbuselibrary{skins,breakable}

\ExplSyntaxOn

% ========================
% Global flags / options
% ========================
\bool_new:N \l_examx_teacher_bool
\bool_new:N \l_examx_autoprint_bool
\bool_new:N \l_examx_show_source_bool
\bool_new:N \l_examx_boxed_bool

% sensible defaults
\bool_gset_false:N \l_examx_teacher_bool   % default: student mode (safer)
\bool_gset_true:N  \l_examx_autoprint_bool % auto print teacher block at end of item
\bool_gset_false:N \l_examx_show_source_bool
\bool_gset_true:N  \l_examx_boxed_bool     % boxed teacher block by default

\DeclareOption{teacher}{\bool_gset_true:N  \l_examx_teacher_bool}
\DeclareOption{student}{\bool_gset_false:N \l_examx_teacher_bool}
\DeclareOption*{} % ignore unknown options
\ProcessOptions\relax

% runtime keys: \examxsetup{autoprint=<bool>, show-source=<bool>, boxed=<bool>}
\keys_define:nn { examx }
  {
    autoprint   .bool_set:N = \l_examx_autoprint_bool,
    autoprint   .initial:n  = true,
    show-source .bool_set:N = \l_examx_show_source_bool,
    show-source .initial:n  = false,
    boxed       .bool_set:N = \l_examx_boxed_bool,
    boxed       .initial:n  = true,
  }
\NewDocumentCommand \examxsetup { m } { \keys_set:nn { examx } { #1 } }

% ========================
% Per-item state
% ========================
\tl_new:N \l_examx_topics_tl
\tl_new:N \l_examx_source_tl
\tl_new:N \l_examx_explain_tl
\tl_new:N \l_examx_diffinput_tl % store raw difficulty input

\cs_new_protected:Npn \examx_reset_per_item:
  {
    \tl_clear:N \l_examx_topics_tl
    \tl_clear:N \l_examx_source_tl
    \tl_clear:N \l_examx_explain_tl
    \tl_clear:N \l_examx_diffinput_tl
  }

% ========================
% Public interfaces
% ========================
\NewDocumentCommand \topics     { m } { \tl_set:Nn \l_examx_topics_tl     {#1} }
\NewDocumentCommand \difficulty { m } { \tl_set:Nn \l_examx_diffinput_tl  {#1} }
\NewDocumentCommand \explain    { m } { \tl_set:Nn \l_examx_explain_tl    {#1} }
\NewDocumentCommand \source     { m } { \tl_set:Nn \l_examx_source_tl     {#1} }

% ========================
% Difficulty formatter
%  - Accept 0..1 decimals; render as percent
%  - Allow user override via \ExamDifficultyFormat
% ========================
\cs_if_exist:NTF \ExamDifficultyFormat
  { \RenewDocumentCommand \ExamDifficultyFormat { m }
      { \fp_eval:n { round((#1)*100,0) } \% } }
  { \NewDocumentCommand \ExamDifficultyFormat { m }
      { \fp_eval:n { round((#1)*100,0) } \% } }

% ========================
% Visuals
% ========================
\definecolor{examxAccent}{RGB}{33,111,219}

\tcbset{
  examxblock/.style={
    enhanced, breakable, colback=white,
    colframe=examxAccent, boxrule=0.5pt, arc=2mm,
    left=6pt, right=6pt, top=4pt, bottom=4pt
  }
}

% ========================
% Printer
% ========================
\cs_new_protected:Npn \examx_print_block:
  {
    \bool_if:NT \l_examx_teacher_bool
      {
        \group_begin:
          \footnotesize
          \tl_if_blank:TF \l_examx_topics_tl   { \tl_set:Nn \l_tmpa_tl { } }
                                             { \tl_set:Nx \l_tmpa_tl { \textbf{考点：} \l_examx_topics_tl \par } }
          \tl_if_blank:TF \l_examx_diffinput_tl
            { \tl_set:Nn \l_tmpb_tl { } }
            { \tl_set:Nx \l_tmpb_tl { \textbf{难度：} \ExamDifficultyFormat{\l_examx_diffinput_tl} \par } }
          \tl_if_blank:TF \l_examx_explain_tl { \tl_set:Nn \l_tmpc_tl { } }
                                             { \tl_set:Nx \l_tmpc_tl { \textbf{详解：} \l_examx_explain_tl \par } }
          \tl_if_blank:TF \l_examx_source_tl  { \tl_set:Nn \l_tmpd_tl { } }
                                             {
                                               \bool_if:NTF \l_examx_show_source_bool
                                                 { \tl_set:Nx \l_tmpd_tl { \textbf{来源：} \l_examx_source_tl \par } }
                                                 { \tl_set:Nn \l_tmpd_tl { } }
                                             }
          \tl_set:Nx \l_tmpe_tl { \l_tmpa_tl \l_tmpb_tl \l_tmpc_tl \l_tmpd_tl }

          \tl_if_blank:NF \l_tmpe_tl
            {
              \bool_if:NTF \l_examx_boxed_bool
                { \begin{tcolorbox}[examxblock] \l_tmpe_tl \end{tcolorbox} }
                { \par\smallskip\hrule height .4pt\relax \par\smallskip \l_tmpe_tl }
            }
        \group_end:
      }
  }

% ========================
% Hooks
% ========================
\AtBeginEnvironment{question}{\examx_reset_per_item:}
\AtEndEnvironment  {question}{\bool_if:NT \l_examx_autoprint_bool { \examx_print_block: }}
\AtBeginEnvironment{problem}{\examx_reset_per_item:}
\AtEndEnvironment  {problem}{\bool_if:NT \l_examx_autoprint_bool { \examx_print_block: }}

% manual trigger (when autoprint=false)
\NewDocumentCommand \printteacherblock { } { \examx_print_block: }

\ExplSyntaxOff
\endinput
