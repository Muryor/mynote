% styles/examx.sty
\NeedsTeXFormat{LaTeX2e}
\ProvidesExplPackage {examx} {2025-10-16} {1.2.0}
  {Unified metadata & teacher/student rendering for exam-zh/ElegantBook}

\RequirePackage{expl3}
\RequirePackage{xparse}
\RequirePackage{etoolbox}
\RequirePackage{l3keys2e}
\RequirePackage{xcolor}
\RequirePackage{tcolorbox}
\tcbuselibrary{skins,breakable}

\ExplSyntaxOn

% ---- global state ----
\bool_new:N \g_examx_teacher_bool
\bool_new:N \g_examx_autoprint_bool
\bool_new:N \g_examx_show_source_bool
\tl_new:N   \g_examx_style_tl

% defaults
\bool_gset_false:N \g_examx_teacher_bool
\bool_gset_true:N  \g_examx_autoprint_bool
\bool_gset_false:N \g_examx_show_source_bool
\tl_gset:Nn \g_examx_style_tl { boxed }

% ---- options & setup ----
\keys_define:nn { examx }
  {
    teacher     .code:n = { \bool_gset_true:N  \g_examx_teacher_bool },
    student     .code:n = { \bool_gset_false:N \g_examx_teacher_bool },
    autoprint   .code:n = { \bool_gset_true:N  \g_examx_autoprint_bool },
    no-autoprint.code:n = { \bool_gset_false:N \g_examx_autoprint_bool },
    show-source .code:n = { \bool_gset_true:N  \g_examx_show_source_bool },
    hide-source .code:n = { \bool_gset_false:N \g_examx_show_source_bool },
    style .choice:,
    style / boxed  .code:n = { \tl_gset:Nn \g_examx_style_tl { boxed } },
    style / simple .code:n = { \tl_gset:Nn \g_examx_style_tl { simple } },
  }
\ProcessKeysOptions{examx}

\NewDocumentCommand \examxsetup { m } { \keys_set:nn { examx } {#1} }

% ---- per-item caches ----
\tl_new:N \l_examx_topics_tl
\tl_new:N \l_examx_source_tl
\tl_new:N \l_examx_explain_tl
\fp_new:N \l_examx_difficulty_fp

\cs_new_protected:Npn \examx_reset_per_item:
  {
    \tl_clear:N \l_examx_topics_tl
    \tl_clear:N \l_examx_source_tl
    \tl_clear:N \l_examx_explain_tl
    \fp_zero:N \l_examx_difficulty_fp
  }

% ---- public interfaces ----
\NewDocumentCommand \topics    { m } { \tl_set:Nn \l_examx_topics_tl   {#1} }
\NewDocumentCommand \difficulty{ m } { \fp_set:Nn \l_examx_difficulty_fp{#1} }
\NewDocumentCommand \explain   { +m }{ \tl_set:Nn \l_examx_explain_tl  {#1} }
\NewDocumentCommand \source    { m } { \tl_set:Nn \l_examx_source_tl   {#1} }

% compatibility aliases
\cs_if_exist:NF \answer   { \NewDocumentCommand \answer   { +m } { \explain{#1} } }
\cs_if_exist:NF \solution { \NewDocumentCommand \solution { +m } { \explain{#1} } }

% difficulty format (overrideable)
\ExplSyntaxOn
\RenewDocumentCommand\ExamDifficultyFormat{m}
  { \fp_eval:n { round((#1)*100,0) } \% }
\ExplSyntaxOff

% ---- rendering ----
\cs_new_protected:Npn \examx_print_block:
  {
    \bool_if:NT \g_examx_autoprint_bool
      {
        \bool_if:NT \g_examx_teacher_bool
          {
            \par\vspace{.6\baselineskip}
            \group_begin:
              \setlength{\parindent}{0pt}
              \tl_if_eq:nnTF { \g_examx_style_tl } { boxed }
                {
                  \begin{tcolorbox}[enhanced,breakable,
                    boxrule=.8pt,sharp corners,
                    colframe=black!35, colback=black!2,
                    title=教师信息（仅教师版可见）]
                    \tl_if_empty:NF \l_examx_explain_tl
                      { \textbf{详解/答案：}\par \l_examx_explain_tl \par }
                    \tl_if_empty:NF \l_examx_topics_tl
                      { \textit{考点：}\l_examx_topics_tl \par }
                    \fp_compare:nNnT { \l_examx_difficulty_fp } > { 0 }
                      { \textit{难度：}\ExamDifficultyFormat{\l_examx_difficulty_fp} \par }
                    \bool_if:NT \g_examx_show_source_bool
                      { \tl_if_empty:NF \l_examx_source_tl
                        { \textit{来源：}\l_examx_source_tl \par } }
                  \end{tcolorbox}
                }
                {
                  \bfseries 详解/答案：\par\normalfont
                  \tl_if_empty:NF \l_examx_explain_tl { \l_examx_explain_tl \par }
                  \tl_if_empty:NF \l_examx_topics_tl  { \textit{考点：}\l_examx_topics_tl \par }
                  \fp_compare:nNnT { \l_examx_difficulty_fp } > { 0 }
                    { \textit{难度：}\ExamDifficultyFormat{\l_examx_difficulty_fp} \par }
                  \bool_if:NT \g_examx_show_source_bool
                    { \tl_if_empty:NF \l_examx_source_tl { \textit{来源：}\l_examx_source_tl \par } }
                }
            \group_end:
          }
      }
  }

% hooks
\AtBeginEnvironment{question}{\examx_reset_per_item:}
\AtEndEnvironment  {question}{\examx_print_block:}
\AtBeginEnvironment{problem} { \examx_reset_per_item:}
\AtEndEnvironment  {problem} { \examx_print_block:}

% manual trigger
\NewDocumentEnvironment{teachernotes}{}{ \examx_print_block: }{}

\ExplSyntaxOff
