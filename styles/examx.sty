%% styles/examx.sty
\NeedsTeXFormat{LaTeX2e}[2020-10-01]
\ProvidesPackage{examx}[2025/11/06 v0.3 Exam extension with qmeta integration]

%% Accept package options [teacher]/[student]; default to student.
%% Keep \ExplSyntaxOn throughout this file per .llmrules.
\RequirePackage{kvoptions}
\SetupKeyvalOptions{family=examx,prefix=examx@}
\DeclareBoolOption[false]{teacher}
\DeclareBoolOption[false]{student}
\ProcessKeyvalOptions*

\ExplSyntaxOn

%% ============================================================
%% Global Booleans (mirroring options)
%% ============================================================
\bool_if_exist:NF \g_examx_teacher_bool { \bool_new:N \g_examx_teacher_bool }
\bool_if_exist:NF \g_examx_student_bool { \bool_new:N \g_examx_student_bool }

\ifexamx@teacher
  \bool_set_true:N  \g_examx_teacher_bool
  \bool_set_false:N \g_examx_student_bool
\else
  \ifexamx@student
    \bool_set_true:N  \g_examx_student_bool
    \bool_set_false:N \g_examx_teacher_bool
  \else
    % default to student if not specified
    \bool_set_true:N  \g_examx_student_bool
    \bool_set_false:N \g_examx_teacher_bool
  \fi
\fi

%% Convenience conditional for downstream logic
\prg_new_conditional:Npnn \examx_if_teacher: { p, T, F, TF }
  { \bool_if:NTF \g_examx_teacher_bool { \prg_return_true: } { \prg_return_false: } }

%% ============================================================
%% Load qmeta with version option
%% ============================================================
\ifexamx@teacher
  \PassOptionsToPackage{version=teacher,show-source=false,difficulty-format=decimal}{qmeta}
\else
  \PassOptionsToPackage{version=student,show-source=false,difficulty-format=decimal}{qmeta}
\fi
\RequirePackage{qmeta}

%% ============================================================
%% Load exam-zh configuration
%% ============================================================
\RequirePackage{fancyhdr}

%% Configure exam-zh based on teacher/student mode (only if exam-zh is loaded)
\@ifclassloaded{exam-zh}{
  \ifexamx@teacher
    % Teacher mode: show answers and solutions
    \examsetup{
      question/show-answer   = true,
      fillin/show-answer     = true,
      paren/show-paren       = true,
      solution/show-solution = show-stay
    }
  \else
    % Student mode: hide answers and solutions
    \examsetup{
      question/show-answer   = false,
      fillin/show-answer     = false,
      paren/show-paren       = false,
      solution/show-solution = hide,
      fillin/no-answer-type  = none
    }
  \fi
}{}

%% ============================================================
%% Helper: Paren Display (teacher shows answer, student empty)
%% ============================================================
\NewDocumentCommand \examx_show_paren { O{} }
  {
    \bool_if:NTF \g_examx_teacher_bool
      { \paren[#1] }
      { \paren[] }
  }

%% ============================================================
%% Quick MCQ Macro
%% ============================================================
\NewDocumentCommand \mcq { O{} m m m m m }
  {
    \begin{question}
      #2~\examx_show_paren[#1]
      \begin{choices}
        \item #3
        \item #4
        \item #5
        \item #6
      \end{choices}
      % Store answer in metadata if provided (must be inside question environment)
      \tl_if_blank:nF {#1} { \answer{#1} }
    \end{question}
  }

%% ============================================================
%% Per-Exam Header Title
%% ============================================================
\NewDocumentCommand \examxtitle { m }
  {
    \pagestyle{fancy}
    \fancyhf{}
    \renewcommand\headrulewidth{0pt}
    \renewcommand\footrulewidth{0pt}
    \fancyhead[C]{\bfseries\Large #1}
    \fancyfoot[C]{\thepage}
  }

\ExplSyntaxOff

\endinput
