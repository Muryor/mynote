% styles/examx.sty (fixed)
\NeedsTeXFormat{LaTeX2e}
\ProvidesExplPackage{examx}{2025-10-29}{1.3.1}
  {Unified metadata & teacher/student rendering for exam-zh (fixed)}

% --- Dependencies
\RequirePackage{expl3}[2022-06-01]
\RequirePackage{xparse}
\RequirePackage{etoolbox}
\RequirePackage{l3keys2e}
\RequirePackage{xcolor}
\RequirePackage{tcolorbox}
\tcbuselibrary{skins,breakable}

\ExplSyntaxOn

% ========================
% Global flags / options
% ========================
\bool_new:N \l_examx_teacher_bool
\bool_new:N \l_examx_autoprint_bool
\bool_new:N \l_examx_show_source_bool
\bool_new:N \l_examx_boxed_bool

% sensible defaults
\bool_gset_false:N \l_examx_teacher_bool   % default: student mode (safer)
\bool_gset_true:N  \l_examx_autoprint_bool % auto print teacher block at end of item
\bool_gset_false:N \l_examx_show_source_bool
\bool_gset_true:N  \l_examx_boxed_bool     % boxed teacher block by default

% package options via l3keys2e
\keys_define:nn { examx }
  {
    teacher   .choice:,
    teacher / true   .code:n = { \bool_gset_true:N  \l_examx_teacher_bool },
    teacher / false  .code:n = { \bool_gset_false:N \l_examx_teacher_bool },
    autoprint .choice:,
    autoprint / true  .code:n = { \bool_gset_true:N  \l_examx_autoprint_bool },
    autoprint / false .code:n = { \bool_gset_false:N \l_examx_autoprint_bool },
    showsource .choice:,
    showsource / true  .code:n = { \bool_gset_true:N  \l_examx_show_source_bool },
    showsource / false .code:n = { \bool_gset_false:N \l_examx_show_source_bool },
    boxed .choice:,
    boxed / true  .code:n = { \bool_gset_true:N  \l_examx_boxed_bool },
    boxed / false .code:n = { \bool_gset_false:N \l_examx_boxed_bool },
  }
\ProcessKeysOptions{examx}

% tcolorbox style for teacher block
\tcbset{
  examxblock/.style={
    enhanced, breakable, colback=white, colframe=black!25,
    boxrule=.4pt, arc=2mm, left=2mm, right=2mm, top=1mm, bottom=1mm
  }
}

% ========================
% Per-item stored data
% ========================
\tl_new:N \l_examx_topics_tl
\tl_new:N \l_examx_source_tl
\tl_new:N \l_examx_explain_tl
\tl_new:N \l_examx_diffinput_tl % store raw difficulty input

\cs_new_protected:Npn \examx_reset_per_item:
  {
    \tl_clear:N \l_examx_topics_tl
    \tl_clear:N \l_examx_source_tl
    \tl_clear:N \l_examx_explain_tl
    \tl_clear:N \l_examx_diffinput_tl
  }

% ========================
% Public interfaces
% ========================
\NewDocumentCommand \topics     { m } { \tl_set:Nn \l_examx_topics_tl     {#1} }
\NewDocumentCommand \difficulty { m } { \tl_set:Nn \l_examx_diffinput_tl  {#1} }
\NewDocumentCommand \explain    { m } { \tl_set:Nn \l_examx_explain_tl    {#1} }
\NewDocumentCommand \source     { m } { \tl_set:Nn \l_examx_source_tl     {#1} }

% ========================
% Difficulty formatter
%  - Accept 0..1 decimals; render as percent
%  - Allow user override via \ExamDifficultyFormat
% ========================
\providecommand\ExamDifficultyFormat[1]{\fp_eval:n { round((#1)*100,0) } \%}

% ========================
% Print teacher block
% ========================
\cs_new_protected:Npn \examx_print_block:
  {
    \bool_if:NT \l_examx_teacher_bool
      {
        \group_begin:
          \footnotesize
          \tl_clear_new:N \l_examx_tmp_tl
          % topics
          \tl_if_blank:VTF \l_examx_topics_tl
            { \tl_clear_new:N \l_tmpa_tl }
            { \tl_set:Nx \l_tmpa_tl { \textbf{考点：} \l_examx_topics_tl \par } }
          % difficulty
          \tl_if_blank:VTF \l_examx_diffinput_tl
            { \tl_clear_new:N \l_tmpb_tl }
            { \tl_set:Nx \l_tmpb_tl { \textbf{难度：} \ExamDifficultyFormat{\l_examx_diffinput_tl} \par } }
          % explain
          \tl_if_blank:VTF \l_examx_explain_tl
            { \tl_clear_new:N \l_tmpc_tl }
            { \tl_set:Nx \l_tmpc_tl { \textbf{详解：} \l_examx_explain_tl \par } }
          % source (optional)
          \tl_if_blank:VTF \l_examx_source_tl
            { \tl_clear_new:N \l_tmpd_tl }
            {
              \bool_if:NTF \l_examx_show_source_bool
                { \tl_set:Nx \l_tmpd_tl { \textbf{来源：} \l_examx_source_tl \par } }
                { \tl_clear_new:N \l_tmpd_tl }
            }
          \tl_set:Nx \l_examx_tmp_tl { \l_tmpa_tl \l_tmpb_tl \l_tmpc_tl \l_tmpd_tl }

          \tl_if_blank:NF \l_examx_tmp_tl
            {
              \bool_if:NTF \l_examx_boxed_bool
                { \begin{tcolorbox}[examxblock] \l_examx_tmp_tl \end{tcolorbox} }
                { \par\smallskip\hrule height .4pt\relax \par\smallskip \l_examx_tmp_tl }
            }
        \group_end:
      }
  }

% ========================
% Hooks
% ========================
\AtBeginEnvironment{question}{\examx_reset_per_item:}
\AtEndEnvironment  {question}{\bool_if:NT \l_examx_autoprint_bool { \examx_print_block: }}
\AtBeginEnvironment{problem}{\examx_reset_per_item:}
\AtEndEnvironment  {problem}{\bool_if:NT \l_examx_autoprint_bool { \examx_print_block: }}

% manual trigger (when autoprint=false)
\NewDocumentCommand \printteacherblock { } { \examx_print_block: }

% ========================
% Robust \choice patch:
%  make \choice immune to optional label parsing of \item when the
%  choice text begins with '[' or '('.
% ========================
\ExplSyntaxOff
\makeatletter
\@ifundefined{choice}
  {\newcommand{\choice}{\item\relax}}
  {\renewcommand{\choice}{\item\relax}}
\makeatother
\ExplSyntaxOn

\ExplSyntaxOff
\endinput
