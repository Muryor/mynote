%% styles/examx.sty
\NeedsTeXFormat{LaTeX2e}[2020-10-01]
\ProvidesPackage{examx}[2025/11/06 v0.4 Exam extension with qmeta integration]

%% Debug: Show load path
\RequirePackage{currfile}
\typeout{[examx]~LOADED~FROM:~\currfileabsdir}

%% Accept package options [teacher]/[student]; default to student.
\RequirePackage{kvoptions}
\SetupKeyvalOptions{family=examx,prefix=examx@}
\DeclareBoolOption[false]{teacher}
\DeclareBoolOption[false]{student}
\ProcessKeyvalOptions*

\ExplSyntaxOn

%% ============================================================
%% Global Booleans (mirroring options)
%% ============================================================
\bool_if_exist:NF \g_examx_teacher_bool { \bool_new:N \g_examx_teacher_bool }
\bool_if_exist:NF \g_examx_student_bool { \bool_new:N \g_examx_student_bool }

\ifexamx@teacher
  \bool_set_true:N  \g_examx_teacher_bool
  \bool_set_false:N \g_examx_student_bool
  \typeout{[examx]~MODE:~teacher}
\else
  \ifexamx@student
    \bool_set_true:N  \g_examx_student_bool
    \bool_set_false:N \g_examx_teacher_bool
    \typeout{[examx]~MODE:~student~(explicit)}
  \else
    % default to student if not specified
    \bool_set_true:N  \g_examx_student_bool
    \bool_set_false:N \g_examx_teacher_bool
    \typeout{[examx]~MODE:~student~(default)}
  \fi
\fi

%% Convenience conditional for downstream logic
\prg_new_conditional:Npnn \examx_if_teacher: { p, T, F, TF }
  { \bool_if:NTF \g_examx_teacher_bool { \prg_return_true: } { \prg_return_false: } }

%% ============================================================
%% Load qmeta with version option
%% ============================================================
\ifexamx@teacher
  \PassOptionsToPackage{version=teacher,show-source=false,difficulty-format=decimal}{qmeta}
\else
  \PassOptionsToPackage{version=student,show-source=false,difficulty-format=decimal}{qmeta}
\fi
\RequirePackage{qmeta}

%% ============================================================
%% Load exam-zh configuration
%% ============================================================
\RequirePackage{fancyhdr}

%% Configure exam-zh based on teacher/student mode (only if exam-zh is loaded)
\@ifclassloaded{exam-zh}{
  \ifexamx@teacher
    % Teacher mode: show answers and solutions
    \examsetup{
      question/show-answer   = true,
      fillin/show-answer     = true,
      fillin/type            = line,
      paren/show-paren       = true,
      solution/show-solution = show-stay,
      question/show-points   = false
    }
  \else
    % Student mode: hide answers and solutions
    \examsetup{
      question/show-answer   = false,
      fillin/show-answer     = false,
      fillin/type            = line,
      fillin/no-answer-type  = none,
      paren/show-paren       = false,
      solution/show-solution = hide,
      question/show-points   = false
    }
  \fi
  % Allow both \choice and \item inside the choices environment
  \providecommand{\choice}{\item}
}{}

%% ============================================================
%% Quick MCQ Macro
%% ============================================================
\NewDocumentCommand \mcq { O{} m m m m m O{} }
  {
    \begin{question}
      #2~\paren[#1]
      \begin{choices}[columns=2]
        \item #3
        \item #4
        \item #5
        \item #6
      \end{choices}
      \tl_if_blank:nF {#1} { \answer{#1} }
      #7
    \end{question}
  }

%% ============================================================
%% Per-Exam Header Title
%% ============================================================
\NewDocumentCommand \examxtitle { m }
  {
    \pagestyle{fancy}
    \fancyhf{}
    \renewcommand\headrulewidth{0pt}
    \renewcommand\footrulewidth{0pt}
    \fancyhead[C]{\bfseries\Large #1}
    \fancyfoot[C]{\thepage}
  }

%% ============================================================
%% MCQ options visibility guard (fallback when exam-zh is absent)
%% ============================================================
\makeatletter
\@ifclassloaded{exam-zh}{%
  % exam-zh is present: do nothing here; it controls choices rendering.
}{%
  % exam-zh missing: provide a simple visible fallback
  \RequirePackage{enumitem}
  \newlist{choices}{enumerate}{1}
  \setlist[choices]{label=\Alph*., leftmargin=*, itemsep=.55\baselineskip}
  \providecommand{\choice}{\item}
  \providecommand{\CorrectChoice}{\item} % in teacher mode you may decorate externally
  \providecommand{\choicelabel}{\Alph{choicesi}.}
}
\makeatother

\ExplSyntaxOff

\endinput
