%% styles/examx.sty
\NeedsTeXFormat{LaTeX2e}[2020-10-01]
\ProvidesPackage{examx}[2025/11/06 v0.4 Exam extension with qmeta integration]

%% Debug: Show load path
\RequirePackage{currfile}
\typeout{[examx]~LOADED~FROM:~\currfileabsdir}

%% Enable enumitem shortlabels for backward compatibility
\PassOptionsToPackage{shortlabels}{enumitem}

%% ğŸ†• v0.5: åŠ è½½ needspace åŒ…ï¼Œç”¨äºé¢˜ç›®å°½é‡ä¸åˆ†é¡µ
\RequirePackage{needspace}

%% Accept package options [teacher]/[student]; default to student.
\RequirePackage{kvoptions}
\SetupKeyvalOptions{family=examx,prefix=examx@}
\DeclareBoolOption[false]{teacher}
\DeclareBoolOption[false]{student}
\ProcessKeyvalOptions*

\ExplSyntaxOn

%% ============================================================
%% Global Booleans (mirroring options)
%% ============================================================
\bool_if_exist:NF \g_examx_teacher_bool { \bool_new:N \g_examx_teacher_bool }
\bool_if_exist:NF \g_examx_student_bool { \bool_new:N \g_examx_student_bool }

\ifexamx@teacher
  \bool_set_true:N  \g_examx_teacher_bool
  \bool_set_false:N \g_examx_student_bool
  \typeout{[examx]~MODE:~teacher}
\else
  \ifexamx@student
    \bool_set_true:N  \g_examx_student_bool
    \bool_set_false:N \g_examx_teacher_bool
    \typeout{[examx]~MODE:~student~(explicit)}
  \else
    % default to student if not specified
    \bool_set_true:N  \g_examx_student_bool
    \bool_set_false:N \g_examx_teacher_bool
    \typeout{[examx]~MODE:~student~(default)}
  \fi
\fi

%% Convenience conditional for downstream logic
\prg_new_conditional:Npnn \examx_if_teacher: { p, T, F, TF }
  { \bool_if:NTF \g_examx_teacher_bool { \prg_return_true: } { \prg_return_false: } }

%% ============================================================
%% Load qmeta with version option
%% ============================================================
\ifexamx@teacher
  \PassOptionsToPackage{version=teacher,show-source=false,difficulty-format=decimal}{qmeta}
\else
  \PassOptionsToPackage{version=student,show-source=false,difficulty-format=decimal}{qmeta}
\fi
\RequirePackage{qmeta}

%% ============================================================
%% Answer metadata helpers (no automatic capture from \paren / \fillin)
%% We no longer override \paren; answers must be explicit.
%% ============================================================
\ProvideDocumentCommand \answers { m } { \answer{#1} }

%% ============================================================
%% Load exam-zh configuration
%% ============================================================
\RequirePackage{fancyhdr}

%% Configure exam-zh based on teacher/student mode (only if exam-zh is loaded)
\@ifclassloaded{exam-zh}{
  \ifexamx@teacher
    % Teacher mode: hide inline answers (show only in metadata box)
    \examsetup{
      question/show-answer   = false,
      fillin/show-answer     = false,
      fillin/type            = line,
      fillin/no-answer-type  = none,
      paren/show-paren       = false,
      solution/show-solution = show-stay,
      question/show-points   = false
    }
  \else
    % Student mode: hide answers and solutions
    \examsetup{
      question/show-answer   = false,
      fillin/show-answer     = false,
      fillin/type            = line,
      fillin/no-answer-type  = none,
      paren/show-paren       = false,
      solution/show-solution = hide,
      question/show-points   = false
    }
  \fi
  % Allow both \choice and \item inside the choices environment
  \providecommand{\choice}{\item}
}{}

%% ============================================================
%% Quick MCQ Macro
%% ============================================================
\NewDocumentCommand \mcq { O{} m m m m m O{} }
  {
    \begin{question}
      #2
      \begin{choices}
        \item #3
        \item #4
        \item #5
        \item #6
      \end{choices}
      \tl_if_blank:nF {#1} { \answer{#1} }
      #7
    \end{question}
  }

%% ============================================================
%% Per-Exam Header Title (first page only)
%% ============================================================
\newcommand\examx@title{}
\fancypagestyle{examxfirstpage}{
  \fancyhf{}
  \renewcommand\headrulewidth{0pt}
  \renewcommand\footrulewidth{0pt}
  \fancyhead[C]{\bfseries\Large \examx@title}
  \fancyfoot[C]{\thepage}
}
\NewDocumentCommand \examxtitle { m }
  {
    \gdef\examx@title{#1}%
    \thispagestyle{examxfirstpage}%
  }

%% ============================================================
%% MCQ options visibility guard (fallback when exam-zh is absent)
%% ============================================================
\makeatletter
\@ifclassloaded{exam-zh}{%
  % exam-zh is present: do nothing here; it controls choices rendering.
}{%
  % exam-zh missing: provide a simple visible fallback
  \RequirePackage{enumitem}
  \newlist{choices}{enumerate}{1}
  \setlist[choices]{label=\Alph*., leftmargin=*, itemsep=.55\baselineskip}
  \providecommand{\choice}{\item}
  \providecommand{\CorrectChoice}{\item} % in teacher mode you may decorate externally
  \providecommand{\choicelabel}{\Alph{choicesi}.}
}
\makeatother

%% ============================================================
%% ğŸ†• v0.5: é¢˜ç›®å°½é‡ä¸åˆ†é¡µ (Keep Questions Together)
%% ============================================================
%% ä½¿ç”¨ needspace åœ¨æ¯ä¸ª question ç¯å¢ƒå‰è¯·æ±‚ä¸€å®šçš„å‚ç›´ç©ºé—´
%% å¦‚æœå‰©ä½™ç©ºé—´ä¸è¶³ï¼Œåˆ™åœ¨é¢˜ç›®å‰åˆ†é¡µï¼Œé¿å…é¢˜ç›®è¢«æ‹†åˆ†
\RequirePackage{etoolbox}
\BeforeBeginEnvironment{question}{%
  \needspace{5\baselineskip}% è‡³å°‘éœ€è¦ 5 è¡Œç©ºé—´ï¼Œå¦åˆ™åˆ†é¡µ
}

\ExplSyntaxOff

\endinput
