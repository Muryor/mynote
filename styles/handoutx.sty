%% styles/handoutx.sty
\NeedsTeXFormat{LaTeX2e}
\ProvidesExplPackage{handoutx}{2025/11/06}{0.2}{Handout style with options}

\RequirePackage{expl3,xparse,kvoptions,fancyhdr,tcolorbox}
\tcbuselibrary{skins,breakable,theorems}

\ExplSyntaxOn

%% ============================================================
%% Options
%% ============================================================
\bool_new:N \l__handoutx_mint_bool
\keys_define:nn { handoutx / opt }
  {
    cover      .bool_set:N = \l__handoutx_cover_bool,
    cover      .initial:n  = true,
    infobar    .bool_set:N = \l__handoutx_infobar_bool,
    infobar    .initial:n  = true,
    authorhead .bool_set:N = \l__handoutx_authorhead_bool,
    authorhead .initial:n  = true,
    theme .choice:,
    theme / green .code:n = { \bool_set_false:N \l__handoutx_mint_bool },
    theme / mint  .code:n = { \bool_set_true:N  \l__handoutx_mint_bool },
    theme .initial:n = green,
  }
\ProcessKeysOptions{ handoutx / opt }

%% ============================================================
%% Load qmeta with teacher version (handouts always show metadata)
%% ============================================================
\PassOptionsToPackage{version=teacher,show-source=false,difficulty-format=decimal}{qmeta}
\RequirePackage{qmeta}

%% ============================================================
%% Page Style & Title Control
%% ============================================================
\AtBeginDocument{
  % cover=false => \maketitle becomes empty
  \bool_if:NF \l__handoutx_cover_bool
    {
      \RenewDocumentCommand \maketitle {}{}
    }

  % Configure headers/footers
  \pagestyle{fancy}
  \fancyhf{}
  \renewcommand\headrulewidth{0pt}
  \renewcommand\footrulewidth{0pt}
  \setlength{\headheight}{15pt}

  % Left header: chapter name
  \fancyhead[L]{\small \nouppercase{\leftmark}}

  % Right header: author (conditional)
  \bool_if:NTF \l__handoutx_authorhead_bool
    {
      \makeatletter
      \fancyhead[R]{\small 作者：\@author}
      \makeatother
    }
    {
      \fancyhead[R]{}
    }

  % Center footer: page number
  \fancyfoot[C]{\thepage}
}

%% ============================================================
%% Color Palette
%% ============================================================
\definecolor{HMain}{RGB}{40,140,90}   % main green
\definecolor{HBack}{RGB}{245,251,247} % light background
\definecolor{LegendGreen}{HTML}{2A776A}
\definecolor{LegendGreenLight}{HTML}{E7F4F1}
\definecolor{LegendMint}{HTML}{3BA58B}
\definecolor{LegendOrange}{HTML}{F5B06A}

%% ============================================================
%% tcolorbox Preset (theme-dependent)
%% ============================================================
\bool_if:NTF \l__handoutx_mint_bool
  {
    % Mint theme: title bar with mint background
    \tcbset{
      mygreen/.style={
        enhanced,
        breakable,
        colback=LegendGreenLight,
        colframe=LegendGreen,
        coltitle=white,
        fonttitle=\bfseries,
        attach~ boxed~ title~ to~ top~ left={xshift=2mm,yshift*=-2mm},
        boxed~ title~ style={frame~ code={},boxrule=0pt,sharp~ corners,colback=LegendMint},
        boxrule=0.8pt,
        arc=2mm,
        left=3mm,
        right=3mm,
        top=2mm,
        bottom=2mm,
      },
    }
  }
  {
    % Green theme (default): original style
    \tcbset{
      mygreen/.style={
        enhanced,
        breakable,
        colback=green!4,
        colframe=green!45!black,
        coltitle=white,
        fonttitle=\bfseries,
        title~ filled,
        boxrule=0.8pt,
        arc=2.5mm,
        left=2mm,
        right=2mm,
        top=1.5mm,
        bottom=1.5mm,
        drop~ shadow=black!20,
        borderline={0.4pt}{0pt}{green!35!black},
      },
    }
  }

%% ============================================================
%% New Environment Names (recommended)
%% ============================================================
\NewDocumentEnvironment{DefBox}{O{定义}}
  {
    \begin{tcolorbox}[mygreen,title={#1}]
  }
  {
    \end{tcolorbox}
  }

\NewDocumentEnvironment{PropBox}{O{性质}}
  {
    \begin{tcolorbox}[mygreen,title={#1}]
  }
  {
    \end{tcolorbox}
  }

\NewDocumentEnvironment{ExBox}{O{例题}}
  {
    \begin{tcolorbox}[mygreen,title={#1}]
  }
  {
    \end{tcolorbox}
  }

\NewDocumentEnvironment{NoteBox}{O{忆}}
  {
    \begin{tcolorbox}[mygreen,title={#1}]
  }
  {
    \end{tcolorbox}
  }

\NewDocumentCommand{\BoxTable}{m}
  {
    \begin{tcolorbox}[mygreen]
      #1
    \end{tcolorbox}
  }

%% ============================================================
%% Backward Compatibility Aliases (old environment names)
%% ============================================================
% Keep old theorem-style environments as aliases
\newtcbtheorem[number~ within=chapter]{definitionx}{定义}{
  mygreen}{def}

\newtcbtheorem[number~ within=chapter]{propertyx}{性质}{
  mygreen}{prop}

\newtcbtheorem[number~ within=chapter]{examplex}{例题}{
  mygreen}{ex}

\newtcbtheorem[]{notebox}{注意}{
  mygreen}{note}

\ExplSyntaxOff

\endinput
