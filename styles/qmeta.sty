%% qmeta.sty
%% Question metadata module for teacher-only blocks
%% Shared by examx.sty and handoutx.sty
\NeedsTeXFormat{LaTeX2e}
\ProvidesExplPackage{qmeta}{2025/11/06}{0.1}{Question metadata block}

%% Debug: Show load path
\RequirePackage{currfile}
\typeout{[qmeta]~LOADED~FROM:~\currfileabsdir}

\RequirePackage{expl3,xparse,tcolorbox}
\tcbuselibrary{skins,breakable}

\ExplSyntaxOn

%% ============================================================
%% Variables (must be created before keys_define uses them)
%% ============================================================
\bool_new:N \l__qmeta_teacher_bool
\bool_new:N \l__qmeta_show_source_bool
\tl_new:N   \l__qmeta_diff_fmt_tl
\tl_new:N   \l__qmeta_answer_tl
\tl_new:N   \l__qmeta_topics_tl
\tl_new:N   \l__qmeta_explain_tl
\tl_new:N   \l__qmeta_source_tl
\fp_new:N   \l__qmeta_diff_fp
\bool_new:N \l__qmeta_headrow_bool
\int_new:N  \l__qmeta_step_int   % 步骤计数器

%% ============================================================
%% Options
%% ============================================================
\keys_define:nn { qmeta / opt }
  {
    version .choice:,
    version / teacher .code:n = { \bool_set_true:N  \l__qmeta_teacher_bool },
    version / student .code:n = { \bool_set_false:N \l__qmeta_teacher_bool },
    version .initial:n = student,
    role .choice:,
    role / teacher .code:n = { \bool_set_true:N  \l__qmeta_teacher_bool },
    role / student .code:n = { \bool_set_false:N \l__qmeta_teacher_bool },
    show-source .bool_set:N = \l__qmeta_show_source_bool,
    show-source .initial:n  = false,
    difficulty-format .choice:,
    difficulty-format / decimal .code:n = { \tl_set:Nn \l__qmeta_diff_fmt_tl { decimal } },
    difficulty-format / percent .code:n = { \tl_set:Nn \l__qmeta_diff_fmt_tl { percent } },
    difficulty-format .initial:n = decimal
  }
\ProcessKeysOptions{ qmeta / opt }

%% ============================================================
%% User Commands
%% ============================================================
\NewDocumentCommand \answer { m }
  { \tl_gset:Nn \l__qmeta_answer_tl {#1} }

\NewDocumentCommand \topics { m }
  { \tl_gset:Nn \l__qmeta_topics_tl {#1} }

\NewDocumentCommand \difficulty { m }
  { \fp_gset:Nn \l__qmeta_diff_fp {#1} }

\NewDocumentCommand \explain { +m }
  { \tl_gset:Nn \l__qmeta_explain_tl {#1} }

\NewDocumentCommand \source { m }
  { \tl_gset:Nn \l__qmeta_source_tl {#1} }

%% Step marker command for long explanations
%% Usage:
%%   \exstep       -> Auto-numbered: (1), (2), (3), ...
%%   \exstep[小结] -> Custom label: 小结
\NewDocumentCommand \exstep { o }
  {
    \par
    \vspace{0.25\baselineskip}
    \IfValueTF {#1}
      {
        % Custom label provided
        \noindent\textbf{#1}~
      }
      {
        % Auto-numbering
        \int_incr:N \l__qmeta_step_int
        \noindent\textbf{(\int_use:N \l__qmeta_step_int)}~
      }
  }

%% ============================================================
%% Internal Functions
%% ============================================================

%% Reset all metadata
\cs_new_protected:Npn \qmeta_reset:
  {
    \tl_gclear:N \l__qmeta_answer_tl
    \tl_gclear:N \l__qmeta_topics_tl
    \tl_gclear:N \l__qmeta_explain_tl
    \tl_gclear:N \l__qmeta_source_tl
    \fp_gzero:N  \l__qmeta_diff_fp
    \int_gzero:N \l__qmeta_step_int  % 重置步骤计数器
  }

%% Format difficulty based on format option
\cs_new:Npn \qmeta_format_difficulty:
  {
    \str_if_eq:VnTF \l__qmeta_diff_fmt_tl { percent }
      { \fp_eval:n { round(\l__qmeta_diff_fp * 100, 0) } \,\% }
      { \fp_eval:n { round(\l__qmeta_diff_fp, 2) } }
  }

%% Simple, hook-safe content check (no lazy eval)
\bool_new:N \l__qmeta_has_content_bool

\cs_new_protected:Npn \qmeta_set_has_content_bool:
  {
    \bool_set_false:N \l__qmeta_has_content_bool
    % Any field non-empty / non-zero => true
    \tl_if_empty:NF \l__qmeta_answer_tl { \bool_set_true:N \l__qmeta_has_content_bool }
    \fp_compare:nNnT { \l__qmeta_diff_fp } > { 0 } { \bool_set_true:N \l__qmeta_has_content_bool }
    \tl_if_empty:NF \l__qmeta_topics_tl { \bool_set_true:N \l__qmeta_has_content_bool }
    \tl_if_empty:NF \l__qmeta_explain_tl { \bool_set_true:N \l__qmeta_has_content_bool }
    \bool_if:NT \l__qmeta_show_source_bool
      { \tl_if_empty:NF \l__qmeta_source_tl { \bool_set_true:N \l__qmeta_has_content_bool } }
  }

%% tcolorbox style for metadata blocks
\tcbset{
  qmetaStyle/.style={
    enhanced,
    breakable,
    colback=cyan!3,           % 更淡的天空蓝背景
    colframe=cyan!30,         % 天空蓝边框
    boxrule=1.2pt,            % 更粗的边框
    arc=2mm,                  % 圆角
    left=3mm,
    right=3mm,
    top=2mm,
    bottom=2mm,
    fontupper=\color{black}   % 黑色文字
  }
}

%% Print teacher-only metadata block
\cs_set_protected:Npn \qmeta_print_teacherblock:
  {
    % Teacher-only gating
    \bool_if:NT \l__qmeta_teacher_bool
      {
        % Content gating
        \qmeta_set_has_content_bool:
        \bool_if:NT \l__qmeta_has_content_bool
          {
            \par\smallskip
            \begin{tcolorbox}[qmetaStyle]
              %=== First row: Difficulty + Answer in the same line ===
              \bool_set_false:N \l__qmeta_headrow_bool

              % Difficulty part
              \fp_compare:nNnT { \l__qmeta_diff_fp } > { 0 }
                {
                  \textbf{【难度】}~\qmeta_format_difficulty:
                  \bool_set_true:N \l__qmeta_headrow_bool
                }

              % Answer part
              \tl_if_empty:NF \l__qmeta_answer_tl
                {
                  \bool_if:NT \l__qmeta_headrow_bool { \qquad }
                  \textbf{【答案】}~\l__qmeta_answer_tl
                  \bool_set_true:N \l__qmeta_headrow_bool
                }

              % Paragraph break only if something was printed on the head row
              \bool_if:NT \l__qmeta_headrow_bool { \par }

              %=== Remaining fields: Topics, Explanation, Source ===
              \tl_if_empty:NF \l__qmeta_topics_tl
                { \textbf{【知识点】}~\l__qmeta_topics_tl \par }

              \tl_if_empty:NF \l__qmeta_explain_tl
                {
                  % Reset step counter at the start of each explanation
                  \int_gzero:N \l__qmeta_step_int
                  \group_begin:
                  % Allow paragraph breaks and set formatting
                  \parskip=0.4\baselineskip
                  \parindent=2em
                  % Allow flexible line breaking for long formulas
                  \emergencystretch=3em
                  % Title followed by content on same line, no indent on first paragraph
                  \noindent\textbf{【详解】}~\l__qmeta_explain_tl
                  \group_end:
                  \par
                }

              \bool_if:NT \l__qmeta_show_source_bool
                {
                  \tl_if_empty:NF \l__qmeta_source_tl
                    { \textbf{【来源】}~\l__qmeta_source_tl \par }
                }
            \end{tcolorbox}
          }
      }
  }

%% ============================================================
%% Automatic Hooks
%% ============================================================

% Hook into exam-zh's question environment
\AddToHook{env/question/begin}{\qmeta_reset:}
\AddToHook{env/question/end}{\qmeta_print_teacherblock:}

% Hook into elegantbook's problem environment
\AddToHook{env/problem/begin}{\qmeta_reset:}
\AddToHook{env/problem/end}{\qmeta_print_teacherblock:}

%% ============================================================
%% Unified authoring wrapper: qexercise
%% ============================================================
% If exam-zh defines 'question', alias qexercise to it
\cs_if_exist:NT \question
  { \NewDocumentEnvironment{qexercise}{ O{} }{ \begin{question}[#1] }{ \end{question} } }

% If 'question' doesn't exist (handout), provide a tcolorbox fallback
\cs_if_exist:NF \question
  {
    \providecolor{LegendGreen}{HTML}{2A776A}
    \providecolor{LegendGreenLight}{HTML}{E7F4F1}
    \NewDocumentEnvironment{qexercise}{ O{} }
      { \begin{tcolorbox}[enhanced,breakable,arc=1.5mm,boxrule=0.6pt,
          colframe=LegendGreen,colback=LegendGreenLight,title={#1},
          left=2mm,right=2mm,top=1mm,bottom=1mm]
        \qmeta_reset: }
      { \end{tcolorbox} \qmeta_print_teacherblock: }
  }

\ExplSyntaxOff

\endinput
