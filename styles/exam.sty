\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{styles/exam}[2025/10/15 vNext exam styling]

\RequirePackage{xparse}
\RequirePackage{etoolbox}
\RequirePackage{enumitem}

\makeatletter

% Detect variant (teacher by default)
\newif\ifExamTeacherMode
\ExamTeacherModetrue
\@ifundefined{examvariant}{
}{
  \ifdefstring{\examvariant}{student}{\ExamTeacherModefalse}{}
  \ifdefstring{\examvariant}{teacher}{\ExamTeacherModetrue}{}
}

% Toggle for per-question points (off for now; use \ExamShowPointstrue to re-enable)
\newif\ifExamShowPoints
\ExamShowPointsfalse

\providecommand\ExamDifficultyFormat[1]{#1}

% Metadata block measurements & state
\newlength\ExamMetaLabelWidth
\setlength\ExamMetaLabelWidth{6.5em}

\newif\ifExamMetaActive
\ExamMetaActivefalse

\newcommand\ExamMetaEnsureSpacing{%
  \ifExamMetaActive\else
    \par\smallskip
    \global\ExamMetaActivetrue
  \fi
}
\newcommand\ExamMetaTearDown{%
  \ifExamMetaActive
    \par\vspace{0.35\baselineskip}%
    \global\ExamMetaActivefalse
  \fi
}

\newcommand\ExamMetaLabel[1]{%
  {\CJKfamily{hei}\fontsize{11pt}{13pt}\selectfont #1}%
}
\newcommand\ExamMetaValue[1]{%
  {\fontsize{10.8pt}{13pt}\selectfont #1}%
}

\newcommand\ExamMetaLine[2]{%
  \ExamMetaEnsureSpacing
  \noindent
  \makebox[\ExamMetaLabelWidth][l]{\ExamMetaLabel{#1}}%
  \begin{minipage}[t]{\dimexpr\linewidth-\ExamMetaLabelWidth\relax}
    \vspace{0pt}%
    \ExamMetaValue{#2}%
  \end{minipage}%
  \par
}

\newcommand\ExamPointsFormat[1]{%
  {\normalfont\bfseries[#1分]}%
}

% Storage slots
\newcommand\ExamTopicsValue{}
\newcommand\ExamDifficultyValue{}
\newcommand\ExamExplainValue{}
\newcommand\ExamAnswerId{}
\newcommand\ExamAnswerValue{}
\newcommand\ExamSourceValue{}
\newcommand\ExamLastPoints{}

\newcommand\ExamResetMetadata{%
  \global\let\ExamTopicsValue\@empty
  \global\let\ExamDifficultyValue\@empty
  \global\let\ExamExplainValue\@empty
  \global\let\ExamAnswerId\@empty
  \global\let\ExamAnswerValue\@empty
  \global\let\ExamSourceValue\@empty
  \global\let\ExamLastPoints\@empty
  \global\ExamMetaActivefalse
}

% Flush metadata between items
\pretocmd{\item}{\ExamMetaTearDown\ExamResetMetadata}{}{}
\AtEndEnvironment{enumerate}{\ExamMetaTearDown\ExamResetMetadata}

% Content-layer interfaces
\NewDocumentCommand{\points}{m}{%
  \global\def\ExamLastPoints{#1}%
  \ifExamShowPoints
    \nobreak\hfill\ExamPointsFormat{#1}%
  \fi
}

\NewDocumentCommand{\topics}{m}{%
  \global\def\ExamTopicsValue{#1}%
  \ifExamTeacherMode
    \ifstrempty{#1}{}{%
      \ExamMetaLine{知识点}{#1}%
    }%
  \fi
}

\NewDocumentCommand{\difficulty}{m}{%
  \global\def\ExamDifficultyValue{#1}%
  \ifExamTeacherMode
    \edef\@tempa{#1}%
    \ifstrempty{\@tempa}{%
      \ExamMetaLine{难度}{\ExamDifficultyFormat{---}}%
    }{%
      \ExamMetaLine{难度}{\ExamDifficultyFormat{#1}}%
    }%
  \fi
}

\NewDocumentCommand{\explain}{m}{%
  \global\def\ExamExplainValue{#1}%
  \ifExamTeacherMode
    \ifstrempty{#1}{}{%
      \ExamMetaLine{详解/答案}{#1}%
    }%
  \fi
}
\NewDocumentCommand{\solution}{m}{\explain{#1}}
\NewDocumentCommand{\analysis}{m}{\explain{#1}}

\NewDocumentCommand{\answer}{mm}{%
  \global\def\ExamAnswerId{#1}%
  \global\def\ExamAnswerValue{#2}%
}

\NewDocumentCommand{\source}{m}{%
  \global\def\ExamSourceValue{#1}%
}

% Section headings stay flush-left under ctex
\@ifpackageloaded{ctex}{
  \ctexset{section/format+=\raggedright}
}{}
\providecommand\ExamSection[1]{\section*{#1}}

% Enumerated layout tweaks
\setlist[enumerate]{label=\arabic*., leftmargin=*, labelsep=0.6em, itemsep=1.1em}

\newlist{choices}{enumerate}{1}
\setlist[choices]{label=\Alph*., align=left, leftmargin=2.2em, itemsep=0.6em}

\NewDocumentCommand{\choice}{m}{%
  \item #1%
}

% Neutral placeholder for fill-in blocks
\newenvironment{fillblank}{}{}

\makeatother
\endinput
