%% settings/preamble.sty  (macOS-safe)
\ProvidesPackage{preamble}[2025/10/15 MyMathLectureNotes preamble]
\RequirePackage{ifxetex}
\RequirePackage{ifluatex}

% --- Compatibility guard for exam-zh + XeLaTeX ---
\makeatletter
% 1) Avoid loading ctex when class is already ctexbook (exam-zh uses ctexbook)
\@ifclassloaded{ctexbook}{%
  \@ifpackageloaded{ctex}{}{%
    \expandafter\let\csname ver@ctex.sty\endcsname\relax
  }%
}{}
% 2) Avoid amssymb when unicode-math is present
\@ifpackageloaded{unicode-math}{%
  \@ifpackageloaded{amssymb}{}{%
    \expandafter\let\csname ver@amssymb.sty\endcsname\relax
  }%
}{}
\makeatother

%%-------------------------
%% Engine guard: LuaLaTeX / XeLaTeX only
%%-------------------------
\ifxetex\else
  \ifluatex\else
    \PackageError{preamble}{This project must be compiled with XeLaTeX or LuaLaTeX}{Use lualatex or xelatex.}
  \fi
\fi

%%-------------------------
%% Core packages
%%-------------------------
\RequirePackage{fontspec}
\RequirePackage{xcolor}
\RequirePackage{amsmath}
\RequirePackage{enumitem}
\RequirePackage{hyperref}
\hypersetup{hidelinks}

%%-------------------------
%% Fonts (Latin + CJK)
%%-------------------------
% IMPORTANT: fix Scale to avoid MatchLowercase/Uppercase pitfalls on mixed CJK
\defaultfontfeatures{Ligatures=TeX,Scale=1.0}

% Latin main/sans/mono with fallback
\makeatletter
\IfFontExistsTF{TeX Gyre Termes}{%
  \setmainfont{TeX Gyre Termes}[
    BoldFont       = * Bold,
    ItalicFont     = * Italic,
    BoldItalicFont = * Bold Italic,
  ]%
}{%
  \IfFontExistsTF{Times New Roman}{%
    \setmainfont{Times New Roman}[Ligatures=TeX]
  }{%
    \setmainfont{Times} % last-resort
  }%
}
\IfFontExistsTF{Helvetica}{\setsansfont{Helvetica}}{\setsansfont{Arial}}
\IfFontExistsTF{Menlo}{\setmonofont{Menlo}}{\setmonofont{Courier New}}
\makeatother

% CJK main/sans/mono using family names only (no Path/Extension)
\makeatletter
\@ifundefined{setCJKmainfont}{}{%
  % 1) Preferred: PingFang SC (macOS)
  \IfFontExistsTF{PingFang SC}{%
    \setCJKmainfont{PingFang SC}[BoldFont={PingFang SC Semibold}]
    \setCJKsansfont{PingFang SC}
    \setCJKmonofont{PingFang SC}
  }{%
    % 2) Fallback: Noto CJK (installable via homebrew cask-fonts)
    \IfFontExistsTF{Noto Serif CJK SC}{%
      \setCJKmainfont{Noto Serif CJK SC}[BoldFont={Noto Serif CJK SC SemiBold}]
      \setCJKsansfont{Noto Sans CJK SC}
      \setCJKmonofont{Noto Sans Mono CJK SC}
    }{%
      % 3) Last resort: System Songti/Heiti (older macs)
      \IfFontExistsTF{Songti SC}{%
        \setCJKmainfont{Songti SC}[BoldFont={Songti SC Bold}]
        \setCJKsansfont{Heiti SC}
        \setCJKmonofont{Heiti SC}
      }{}
    }%
  }%
}
\makeatother

% Math font: only if unicode-math is loaded
\makeatletter
\@ifpackageloaded{unicode-math}{%
  \IfFontExistsTF{STIX Two Math}{\setmathfont{STIX Two Math}}{%
    \IfFontExistsTF{XITS Math}{\setmathfont{XITS Math}}{}%
  }%
}{}%
\makeatother

% Optional: Roman numeral fallback (Ⅱ, Ⅲ ...)
\makeatletter
\IfFontExistsTF{TeX Gyre Termes}{%
  \newfontfamily\RomanFallback{TeX Gyre Termes}[Scale=1.0]
}{%
  \newfontfamily\RomanFallback{Times New Roman}[Scale=1.0]
}
\makeatother
\newcommand{\useRomanFallback}[1]{{\RomanFallback #1}}

%%-------------------------
%% Colors & math numbering
%%-------------------------
\definecolor{ExamGray}{gray}{0.35}
\numberwithin{equation}{section}

%%-------------------------
%% Heiti alias (defensive)
%%-------------------------
\makeatletter
\@ifundefined{heiti}{\newcommand\heiti{\bfseries}}{}
\makeatother

%%-------------------------
%% \zihao fallback (keep this block)
%%-------------------------
\makeatletter
\@ifundefined{zihao}{%
  \newcommand\zihao[1]{%
    \begingroup
      \def\Exam@v{#1}%
      \def\Exam@pt{}%
      \edef\Exam@vstr{\detokenize{#1}}%
      \ifx\Exam@vstr\@empty
        \let\Exam@pt\relax
      \else
        \ifnum#1=2\relax      \def\Exam@pt{22}%
        \else\ifnum#1=3\relax \def\Exam@pt{16}%
        \else\ifnum#1=4\relax \def\Exam@pt{14}%
        \else\ifnum#1=5\relax \def\Exam@pt{10.5}%
        \else                 \let\Exam@pt\relax
        \fi\fi\fi\fi
      \fi
      \ifx\Exam@pt\relax
        \normalsize
      \else
        \fontsize{\Exam@pt}{1.2\Exam@pt}\selectfont
      \fi
    \endgroup
  }%
}{}
\makeatother

% --- examx compatibility fallbacks (no-op if undefined) ---
\makeatletter
\@ifundefined{points}{\newcommand{\points}[1]{}}{}
\@ifundefined{solutionbox}{\newenvironment{solutionbox}{}{}{}}{}
\makeatother
