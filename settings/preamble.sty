% settings/preamble.sty — Math handout fonts (robust, v1.5)
\ProvidesPackage{preamble}[2025/11/05 v1.5 Math handout fonts (robust, mono fallbacks)]

% -------- Engine guard --------
\RequirePackage{iftex}
\ifXeTeX\else\ifLuaTeX\else
  \PackageError{preamble}{This template requires XeLaTeX or LuaLaTeX}{Use XeLaTeX or LuaLaTeX.}
\fi\fi

% -------- Base packages --------
\RequirePackage{fontspec}
\RequirePackage{unicode-math}
\RequirePackage{xeCJK}
\RequirePackage{ctex}
\RequirePackage{lastpage} % provide \label{LastPage} for page references

\defaultfontfeatures{Ligatures=TeX}

% =========================
% Main Latin text font
% =========================
\IfFontExistsTF{STIX Two Text}{%
  \setmainfont{STIX Two Text}% let fontspec resolve faces; missing faces warn only
}{%
  \IfFontExistsTF{TeX Gyre Termes}{%
    \setmainfont{TeX Gyre Termes}%
  }{%
    \IfFontExistsTF{TeX Gyre Termes X}{%
      \setmainfont{TeX Gyre Termes X}%
    }{%
      \IfFontExistsTF{Times New Roman}{%
        \setmainfont{Times New Roman}%
      }{%
        \setmainfont{Latin Modern Roman}%
      }%
    }%
  }%
}

% Sans — TGHeros / Helvetica / Arial (Inter removed for compatibility)
\IfFontExistsTF{TeX Gyre Heros}{%
  \setsansfont{TeX Gyre Heros}%
}{%
  \IfFontExistsTF{Helvetica}{%
    \setsansfont{Helvetica}%
  }{%
    \IfFontExistsTF{Arial}{%
      \setsansfont{Arial}%
    }{%
      \IfFontExistsTF{Latin Modern Sans}{%
        \setsansfont{Latin Modern Sans}%
      }{%
        % Final fallback: reuse a serif if no sans available
        \setsansfont{Latin Modern Roman}%
      }%
    }%
  }%
}

% =========================
% Mono — robust cascade (fixes 'Latin Modern Mono not found')
% =========================
\newif\ifpreamble@monoset
\preamble@monosetfalse
\IfFontExistsTF{JetBrains Mono}{\setmonofont{JetBrains Mono}\preamble@monosettrue}{}
\ifpreamble@monoset\else
  \IfFontExistsTF{Fira Code}{\setmonofont{Fira Code}\preamble@monosettrue}{}
\fi
\ifpreamble@monoset\else
  \IfFontExistsTF{Latin Modern Mono}{\setmonofont{Latin Modern Mono}\preamble@monosettrue}{}
\fi
\ifpreamble@monoset\else
  \IfFontExistsTF{TeX Gyre Cursor}{\setmonofont{TeX Gyre Cursor}\preamble@monosettrue}{}
\fi
\ifpreamble@monoset\else
  \IfFontExistsTF{Courier New}{\setmonofont{Courier New}\preamble@monosettrue}{}
\fi
\ifpreamble@monoset\else
  \IfFontExistsTF{Monaco}{\setmonofont{Monaco}\preamble@monosettrue}{}
\fi
\ifpreamble@monoset\else
  % Last resort: fall back to main text font as mono to avoid hard errors
  \setmonofont{\rmdefault}
\fi

% =========================
% Math fonts (unicode-math)
% =========================
\IfFontExistsTF{STIX Two Math}{%
  \setmathfont{STIX Two Math}%
}{%
  \IfFontExistsTF{Libertinus Math}{%
    \setmathfont{Libertinus Math}%
  }{%
    \IfFontExistsTF{XITS Math}{%
      \setmathfont{XITS Math}%
    }{%
      \IfFontExistsTF{TeX Gyre Termes Math}{%
        \setmathfont{TeX Gyre Termes Math}%
      }{%
        \setmathfont{Latin Modern Math}%
      }%
    }%
  }%
}

% =========================
% CJK fonts (xeCJK/ctex)
% =========================
\IfFontExistsTF{PingFang SC}{%
  \setCJKmainfont{PingFang SC}%
}{%
  \IfFontExistsTF{Noto Serif CJK SC}{%
    \setCJKmainfont{Noto Serif CJK SC}%
  }{%
    \IfFontExistsTF{Source Han Serif SC}{%
      \setCJKmainfont{Source Han Serif SC}%
    }{%
      \IfFontExistsTF{STSong}{%
        \setCJKmainfont{STSong}%
      }{}%
    }%
  }%
}

\IfFontExistsTF{PingFang SC}{%
  \setCJKsansfont{PingFang SC}%
}{%
  \IfFontExistsTF{Noto Sans CJK SC}{%
    \setCJKsansfont{Noto Sans CJK SC}%
  }{%
    \IfFontExistsTF{Source Han Sans SC}{%
      \setCJKsansfont{Source Han Sans SC}%
    }{%
      \IfFontExistsTF{STHeiti}{%
        \setCJKsansfont{STHeiti}%
      }{}%
    }%
  }%
}

\IfFontExistsTF{Noto Sans Mono CJK SC}{%
  \setCJKmonofont{Noto Sans Mono CJK SC}%
}{%
  \IfFontExistsTF{PingFang SC}{%
    \setCJKmonofont{PingFang SC}%
  }{%
    \IfFontExistsTF{STFangsong}{%
      \setCJKmonofont{STFangsong}%
    }{}%
  }%
}

% =========================
% TikZ 绘图支持
% =========================
\RequirePackage{xcolor}       % 颜色支持 (TikZ 需要)
\RequirePackage{tikz}
\RequirePackage{tikz-3dplot}  % 3D 图形支持

\usetikzlibrary{
  arrows.meta,      % 箭头样式
  calc,             % 坐标计算
  intersections,    % 交点
  angles,           % 角度标记
  quotes,           % 引用标签
  patterns,         % 填充图案
  positioning,      % 节点定位
  decorations.markings  % 路径装饰
}

% 加载统一样式
\input{settings/tikz_exam_style.tex}

% =========================
% MCQ safety net (global)
% =========================
\RequirePackage{etoolbox}
\providecommand\choicelabel{\Alph{choicesi}.}
\AtBeginEnvironment{choices}{\setlength{\itemsep}{0.75em}}
\AtBeginDocument{%
  \renewcommand{\vec}[1]{\overrightarrow{#1}}%
}