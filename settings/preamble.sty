% settings/preamble.sty — Math handout font setup (macOS-friendly)
\ProvidesPackage{settings/preamble}[2025/11/05 v1.0 Math handout fonts]

% -------- Engine guard --------
\RequirePackage{iftex}
\ifXeTeX\else\ifLuaTeX\else
  \PackageError{settings/preamble}{This template requires XeLaTeX or LuaLaTeX}{}
\fi\fi

% -------- Base packages --------
\RequirePackage{fontspec}
\RequirePackage{xeCJK}   % CJK
\RequirePackage{ctex}    % sensible CJK defaults on CN locales
\RequirePackage{unicode-math}

% Keep TeX-like math input feeling
\unimathsetup{
  math-style = TeX,
  bold-style = TeX,
  nabla      = italic,
  partial    = italic,
}

% -------- Helpers --------
\ExplSyntaxOn
\cs_set_eq:NN \IfFontExistsTF \fontspec_if_font_exists:nTF
\ExplSyntaxOff

% =========================
% Latin text fonts (serif/sans/mono)
% =========================
% Serif (main text) — prefer STIX Two Text to match STIX Two Math
\IfFontExistsTF{STIX Two Text}{
  \setmainfont{STIX Two Text}[
    Ligatures=TeX
  ]
}{
  \IfFontExistsTF{TeX Gyre Termes}{
    \setmainfont{TeX Gyre Termes}[Ligatures=TeX]
  }{
    \IfFontExistsTF{Times New Roman}{
      \setmainfont{Times New Roman}[Ligatures=TeX]
    }{
      \setmainfont{Latin Modern Roman}[Ligatures=TeX]
    }
  }
}

% Sans (headings)
\IfFontExistsTF{Helvetica Neue}{
  \setsansfont{Helvetica Neue}[Ligatures=TeX]
}{
  \IfFontExistsTF{TeX Gyre Heros}{
    \setsansfont{TeX Gyre Heros}[Ligatures=TeX]
  }{
    \IfFontExistsTF{Arial}{
      \setsansfont{Arial}[Ligatures=TeX]
    }{
      \setsansfont{Latin Modern Sans}[Ligatures=TeX]
    }
  }
}

% Mono (code)
\IfFontExistsTF{Menlo}{
  \setmonofont{Menlo}
}{
  \IfFontExistsTF{SF Mono}{
    \setmonofont{SF Mono}
  }{
    \IfFontExistsTF{Inconsolata}{
      \setmonofont{Inconsolata}
    }{
      \setmonofont{Latin Modern Mono}
    }
  }
}

% =========================
% Math fonts (unicode-math)
% =========================
% Priority: STIX Two Math -> Libertinus Math -> XITS Math -> TeX Gyre Termes Math -> Latin Modern Math
\ExplSyntaxOn
\cs_new_protected:Npn \__mynote_set_math_font:
 {
  \IfFontExistsTF{STIX Two Math}{
    \setmathfont{STIX Two Math}
  }{
    \IfFontExistsTF{Libertinus Math}{
      \setmathfont{Libertinus Math}
    }{
      \IfFontExistsTF{XITS Math}{
        \setmathfont{XITS Math}
      }{
        \IfFontExistsTF{TeX Gyre Termes Math}{
          \setmathfont{TeX Gyre Termes Math}
        }{
          \setmathfont{Latin Modern Math}
        }
      }
    }
  }
 }
\__mynote_set_math_font:
\ExplSyntaxOff

% =========================
% Chinese (CJK) fonts with graceful fallback
% =========================
% Main CJK (serif) — print-friendly for math handouts
\IfFontExistsTF{Noto Serif CJK SC}{
  \setCJKmainfont{Noto Serif CJK SC}
}{
  \IfFontExistsTF{Songti SC}{
    \setCJKmainfont{Songti SC}
  }{
    \IfFontExistsTF{STSong}{
      \setCJKmainfont{STSong}
    }{
      \IfFontExistsTF{SimSun}{
        \setCJKmainfont{SimSun}
      }{}
    }
  }
}

% CJK sans — headings/notes
\IfFontExistsTF{Noto Sans CJK SC}{
  \setCJKsansfont{Noto Sans CJK SC}
}{
  \IfFontExistsTF{PingFang SC}{
    \setCJKsansfont{PingFang SC}
  }{
    \IfFontExistsTF{STXihei}{
      \setCJKsansfont{STXihei}
    }{}
  }
}

% CJK mono — use a legible sans as fallback; true mono CJK is rare
\IfFontExistsTF{Noto Sans Mono CJK SC}{
  \setCJKmonofont{Noto Sans Mono CJK SC}
}{
  \IfFontExistsTF{PingFang SC}{
    \setCJKmonofont{PingFang SC}
  }{
    \IfFontExistsTF{STFangsong}{
      \setCJKmonofont{STFangsong}
    }{}
  }
}

% =========================
% Optional: a quick preset toggle for macOS UI look (commented out)
% Uncomment the block to switch Chinese to PingFang for everything.
% =========================
% \IfFontExistsTF{PingFang SC}{
%   \setCJKmainfont{PingFang SC}
%   \setCJKsansfont{PingFang SC}
%   \setCJKmonofont{PingFang SC}
% }{}

% --- End of preamble font setup ---
