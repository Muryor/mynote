% settings/preamble.sty — Math handout font setup (macOS-friendly)
\ProvidesPackage{settings/preamble}[2025/11/05 v1.3 Math handout fonts]

% -------- Engine guard --------
\RequirePackage{iftex}
\ifXeTeX\else\ifLuaTeX\else
  \PackageError{settings/preamble}{This template requires XeLaTeX or LuaLaTeX}{Use XeLaTeX or LuaLaTeX.}
\fi\fi

% -------- Base packages --------
\RequirePackage{fontspec}
\RequirePackage{xeCJK}   % CJK
\RequirePackage{ctex}    % sensible CJK defaults
\RequirePackage{unicode-math}

\defaultfontfeatures{Ligatures=TeX}

% Keep TeX-like math input feeling
\unimathsetup{
  math-style = TeX,
  bold-style = TeX,
  nabla      = italic,
  partial    = italic,
}

% =========================
% Latin text fonts (serif/sans/mono)
% =========================
% Serif (main text) — prefer STIX Two Text to match STIX Two Math
\IfFontExistsTF{STIX Two Text}{%
  \setmainfont{STIX Two Text}%
}{%
  \IfFontExistsTF{TeX Gyre Termes}{%
    \setmainfont{TeX Gyre Termes}%
  }{%
    \IfFontExistsTF{Times New Roman}{%
      \setmainfont{Times New Roman}%
    }{%
      \setmainfont{Latin Modern Roman}%
    }%
  }%
}%

% Sans (headings)
\IfFontExistsTF{Helvetica Neue}{%
  \setsansfont{Helvetica Neue}[Scale=MatchLowercase]%
}{%
  \IfFontExistsTF{TeX Gyre Heros}{%
    \setsansfont{TeX Gyre Heros}[Scale=MatchLowercase]%
  }{%
    \IfFontExistsTF{Arial}{%
      \setsansfont{Arial}[Scale=MatchLowercase]%
    }{%
      \setsansfont{Latin Modern Sans}[Scale=MatchLowercase]%
    }%
  }%
}%

% Mono (code)
\IfFontExistsTF{Menlo}{%
  \setmonofont{Menlo}[Scale=MatchLowercase]%
}{%
  \IfFontExistsTF{SF Mono}{%
    \setmonofont{SF Mono}[Scale=MatchLowercase]%
  }{%
    \IfFontExistsTF{Inconsolata}{%
      \setmonofont{Inconsolata}[Scale=MatchLowercase]%
    }{%
      \setmonofont{Latin Modern Mono}[Scale=MatchLowercase]%
    }%
  }%
}%

% =========================
% Math fonts (unicode-math)
% =========================
\IfFontExistsTF{STIX Two Math}{%
  \setmathfont{STIX Two Math}%
}{%
  \IfFontExistsTF{Libertinus Math}{%
    \setmathfont{Libertinus Math}%
  }{%
    \IfFontExistsTF{XITS Math}{%
      \setmathfont{XITS Math}%
    }{%
      \IfFontExistsTF{TeX Gyre Termes Math}{%
        \setmathfont{TeX Gyre Termes Math}%
      }{%
        \setmathfont{Latin Modern Math}%
      }%
    }%
  }%
}%

% =========================
% Chinese (CJK) fonts with graceful fallback
% =========================
% Main CJK (serif) — print-friendly for math handouts
\IfFontExistsTF{Noto Serif CJK SC}{%
  \setCJKmainfont{Noto Serif CJK SC}%
}{%
  \IfFontExistsTF{Songti SC}{%
    \setCJKmainfont{Songti SC}%
  }{%
    \IfFontExistsTF{STSong}{%
      \setCJKmainfont{STSong}%
    }{%
      \IfFontExistsTF{SimSun}{%
        \setCJKmainfont{SimSun}%
      }{}%
    }%
  }%
}%

% CJK sans — headings/notes
\IfFontExistsTF{Noto Sans CJK SC}{%
  \setCJKsansfont{Noto Sans CJK SC}%
}{%
  \IfFontExistsTF{PingFang SC}{%
    \setCJKsansfont{PingFang SC}%
  }{%
    \IfFontExistsTF{STXihei}{%
      \setCJKsansfont{STXihei}%
    }{}%
  }%
}%

% CJK mono — use a legible sans as fallback; true mono CJK is rare
\IfFontExistsTF{Noto Sans Mono CJK SC}{%
  \setCJKmonofont{Noto Sans Mono CJK SC}%
}{%
  \IfFontExistsTF{PingFang SC}{%
    \setCJKmonofont{PingFang SC}%
  }{%
    \IfFontExistsTF{STFangsong}{%
      \setCJKmonofont{STFangsong}%
    }{}%
  }%
}%

% --- End of preamble font setup ---
